<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Appraisells - Fine Art Professional Appraisals</title>
  
  <!-- Pi Browser Optimization -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <!-- Pi SDK - Critical for Pi Browser -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Banner -->
   <header>
    <h1>APPRAISELLS</h1>
  </header>

  <h3>FINE ART. PROFESSIONAL APPRAISALS.</h3>

 <!-- Pi Network Login Button -->
  <div id="login-section" style="margin-top: 100px; text-align: center;">
    <button onclick="login()" id="loginBtn" style="padding:12px 25px; font-size:2em; background-color:#030006; color: white; border:none; border-radius:6px; cursor:pointer;">Login with Pi Browser</button>
  </div>

  <!-- Backend Test Section -->
  <div id="backend-test-section" style="margin-top: 40px; text-align: center;">
    <h4 style="color: #666;">üîß Technical Tests</h4>
    <button onclick="testBackendConnection()" id="backendTestBtn" style="padding:8px 16px; font-size:1.2em; background-color:#17a2b8; color: white; border:none; border-radius:4px; cursor:pointer; margin: 5px;">Test Backend Connection</button>
    <button onclick="window.open('pi_diagnostic.html', '_blank')" style="padding:8px 16px; font-size:1.2em; background-color:#6c757d; color: white; border:none; border-radius:4px; cursor:pointer; margin: 5px;">Full Diagnostic</button>
  </div>

  <!-- Test Results Display -->
  <div id="test-results" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; font-family: monospace; font-size: 14px; display: none;">
    <strong>üß™ Test Results:</strong><br>
    <div id="test-output"></div>
  </div>

  <!-- Pi Browser Detection Message -->
  <div id="browser-warning" style="display: none; margin-top: 20px; text-align: center; color: #d9534f; font-size: 1.1em;">
    ‚ö†Ô∏è This app requires Pi Browser to function properly.<br>
    Please open <strong>https://cenpenadmin.github.io/php-appraisells/</strong> in Pi Browser.
  </div>

  <!-- Loading indicator for Pi SDK -->
  <div id="pi-loading" style="display: none; margin-top: 20px; text-align: center; color: #666;">
    üîÑ Loading Pi SDK...
  </div>

  <script src="script.js"></script>
  
  <script>
    // Enhanced Pi Browser detection and SDK loading
    document.addEventListener('DOMContentLoaded', function() {
      const isPiBrowser = navigator.userAgent.includes('Pi Browser') || navigator.userAgent.includes('iPhone');
      const warningDiv = document.getElementById('browser-warning');
      const loadingDiv = document.getElementById('pi-loading');
      
      if (!isPiBrowser) {
        warningDiv.style.display = 'block';
        console.warn('Not in Pi Browser - app functionality will be limited');
      } else {
        // Show loading indicator while Pi SDK loads
        loadingDiv.style.display = 'block';
        
        // Wait for Pi SDK to be available
        let checkCount = 0;
        const checkPiSDK = setInterval(() => {
          checkCount++;
          if (typeof Pi !== 'undefined') {
            loadingDiv.style.display = 'none';
            console.log('‚úÖ Pi SDK loaded successfully');
            clearInterval(checkPiSDK);
          } else if (checkCount > 50) { // 10 seconds
            loadingDiv.innerHTML = '‚ùå Pi SDK failed to load. Please refresh the page.';
            clearInterval(checkPiSDK);
          }
        }, 200);
      }
    });

    // Backend connection test function
    async function testBackendConnection() {
      const resultsDiv = document.getElementById('test-results');
      const outputDiv = document.getElementById('test-output');
      const testBtn = document.getElementById('backendTestBtn');
      
      // Show results area and update button
      resultsDiv.style.display = 'block';
      testBtn.disabled = true;
      testBtn.textContent = 'Testing...';
      outputDiv.innerHTML = '';
      
      function addTestResult(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const color = type === 'success' ? 'green' : type === 'error' ? 'red' : type === 'warning' ? 'orange' : 'blue';
        outputDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
      }
      
      addTestResult('üîÑ Starting backend connection test...', 'info');
      
      // Test 1: Check if ngrok tunnel is accessible
      try {
        addTestResult('üì° Testing ngrok tunnel: https://4943480ece59.ngrok-free.app', 'info');
        
        const response = await fetch('https://4943480ece59.ngrok-free.app/health', {
          method: 'GET',
          headers: {
            'ngrok-skip-browser-warning': 'true',
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          addTestResult(`‚úÖ Backend health check successful!`, 'success');
          addTestResult(`üìä Server Status: ${data.status}`, 'success');
          addTestResult(`üêò PHP Version: ${data.php_version}`, 'success');
          addTestResult(`üóÑÔ∏è Database: ${data.databaseConnected ? 'Connected' : 'Not Connected'}`, data.databaseConnected ? 'success' : 'warning');
          addTestResult(`üîê Pi API Key: ${data.piApiKeySet ? 'Configured' : 'Not Set'}`, data.piApiKeySet ? 'success' : 'warning');
          
          // Test 2: Test a simple API endpoint
          try {
            addTestResult('üß™ Testing API endpoint...', 'info');
            const apiResponse = await fetch('https://4943480ece59.ngrok-free.app/subscription-status/testuser', {
              headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            
            if (apiResponse.ok) {
              const apiData = await apiResponse.json();
              addTestResult('‚úÖ API endpoint responding correctly', 'success');
            } else {
              addTestResult(`‚ö†Ô∏è API endpoint returned ${apiResponse.status}`, 'warning');
            }
          } catch (apiError) {
            addTestResult(`‚ùå API test failed: ${apiError.message}`, 'error');
          }
          
        } else {
          addTestResult(`‚ùå Health check failed: ${response.status} ${response.statusText}`, 'error');
        }
        
      } catch (error) {
        addTestResult(`‚ùå Backend connection failed: ${error.message}`, 'error');
        addTestResult('üí° Possible issues:', 'info');
        addTestResult('   ‚Ä¢ ngrok tunnel not running (run: ngrok http 80)', 'info');
        addTestResult('   ‚Ä¢ XAMPP Apache not started', 'info');
        addTestResult('   ‚Ä¢ Firewall blocking connection', 'info');
        addTestResult('   ‚Ä¢ Internet connection issues', 'info');
      }
      
      // Test 3: Check if local XAMPP is running (if accessible)
      try {
        addTestResult('üè† Testing local XAMPP (localhost)...', 'info');
        const localResponse = await fetch('http://localhost/health', {
          method: 'GET'
        });
        
        if (localResponse.ok) {
          addTestResult('‚úÖ Local XAMPP is accessible', 'success');
        } else {
          addTestResult('‚ö†Ô∏è Local XAMPP responded but with errors', 'warning');
        }
      } catch (localError) {
        addTestResult('‚ùå Local XAMPP not accessible (normal if using ngrok only)', 'info');
      }
      
      addTestResult('=== TEST COMPLETE ===', 'info');
      
      // Reset button
      testBtn.disabled = false;
      testBtn.textContent = 'Test Backend Connection';
    }
  </script>
</body>
</html>
