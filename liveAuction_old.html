<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Auction - Appraisells</title>
    
    <!-- Configuration -->
    <script src="script.js"></script>
    
    <!-- Pi SDK -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    
    <link rel="stylesheet" href="style.css">
    
    <style>
        .auction-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .auction-title {
            text-align: center;
            font-size: 2em;
            margin: 30px 0;
            color: #030006;
        }
        
        .auction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin: 20px 0;
        }
        
        .auction-item {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            background: #f9f9f9;
            text-align: center;
            transition: box-shadow 0.3s ease;
        }
        
        .auction-item:hover {
            box-shadow: 0 4px 15px rgba(3, 0, 6, 0.2);
        }
        
        .artist-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #030006;
            margin-bottom: 8px;
        }
        
        .artwork-title {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 15px;
            font-style: italic;
        }
        
        .reserve-bid {
            font-size: 1.1em;
            font-weight: bold;
            color: #030006;
            margin-bottom: 20px;
        }
        
        .artwork-image {
            width: 100%;
            height: 240px;
            background: #ddd;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin: 15px 0;
            object-fit: cover;
        }
        
        .current-bid {
            font-size: 1.3em;
            font-weight: bold;
            color: #d4006e;
            margin: 15px 0;
        }
        
        .bid-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1.1em;
            text-align: center;
        }
        
        .bid-button {
            width: 100%;
            padding: 12px;
            background-color: #030006;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .bid-button:hover {
            background-color: #222;
        }
        
        .bid-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #030006;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            margin: 20px;
        }
        
        .back-button:hover {
            background-color: #222;
        }
        
        .highest-bidder {
            font-size: 0.9em;
            color: #666;
            margin: 5px 0;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            text-align: center;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>

<body>
    <header>
        <h1>APPRAISELLS</h1>
    </header>
    
    <a href="profile.html" class="back-button">← Back to Profile</a>
    
    <div class="auction-container">
        <h2 class="auction-title">Live Digital Art Auction</h2>
        
        <div id="statusMessage" class="status-message loading" style="display: none;">
            Loading auction data...
        </div>
        
        <div class="auction-grid" id="auctionGrid">
            <!-- Auction items will be loaded here -->
        </div>
    </div>

    <script>
        let piUser = null;
        let auctionItems = [];
        let highestBids = {};
        
        // Define auction items
        const AUCTION_ITEMS = [
            {
                itemId: 'item1',
                artistName: 'Digital Artist',
                artworkTitle: 'Abstract Composition #1',
                reserveBid: 5.00,
                imagePath: 'images/middle finger man.png',
                description: 'Unique digital artwork'
            },
            {
                itemId: 'item2',
                artistName: 'Digital Artist',
                artworkTitle: 'Abstract Composition #2',
                reserveBid: 3.00,
                imagePath: 'images/SueHipple1.jpg',
                description: 'Beautiful digital creation'
            },
            {
                itemId: 'item3',
                artistName: 'Digital Artist',
                artworkTitle: 'Abstract Composition #3',
                reserveBid: 4.00,
                imagePath: 'images/SueHipple2.jpg',
                description: 'Artistic digital piece'
            },
            {
                itemId: 'item4',
                artistName: 'Digital Artist',
                artworkTitle: 'Abstract Composition #4',
                reserveBid: 6.00,
                imagePath: 'images/SueHipple3.jpg',
                description: 'Creative digital artwork'
            },
            {
                itemId: 'item5',
                artistName: 'Digital Artist',
                artworkTitle: 'Abstract Composition #5',
                reserveBid: 2.00,
                imagePath: 'images/SueHipple4.jpg',
                description: 'Expressive digital art'
            }
        ];
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            authenticateUser().then(() => {
                loadAuctionData();
            });
        });
        
        // Authenticate user with Pi Network
        async function authenticateUser() {
            try {
                showStatus('Authenticating with Pi Network...', 'loading');
                
                const auth = await Pi.authenticate(['username', 'payments'], onIncompletePaymentFound);
                piUser = auth.user;
                
                console.log('User authenticated:', piUser.username);
                showStatus('Authentication successful!', 'success');
                
                // Log authentication
                await logAuthentication(piUser.username, piUser.uid, true);
                
                setTimeout(() => {
                    document.getElementById('statusMessage').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Authentication failed:', error);
                showStatus('Authentication failed. Please use Pi Browser.', 'error');
                
                // Still allow viewing but disable bidding
                setTimeout(() => {
                    loadAuctionData();
                }, 2000);
            }
        }
        
        // Handle incomplete payments
        function onIncompletePaymentFound(payment) {
            console.log('Found incomplete payment:', payment.identifier);
            return Pi.completePayment(payment.identifier);
        }
        
        // Log authentication to backend
        async function logAuthentication(username, userUid, authSuccess) {
            try {
                await fetch(`${CONFIG.BACKEND_URL}/api.php/log-authentication`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        userUid: userUid,
                        authSuccess: authSuccess
                    })
                });
            } catch (error) {
                console.error('Error logging authentication:', error);
            }
        }
        
        // Load auction data
        async function loadAuctionData() {
            try {
                showStatus('Loading auction data...', 'loading');
                
                // Load highest bids
                await loadHighestBids();
                
                // Render auction items
                renderAuctionItems();
                
                document.getElementById('statusMessage').style.display = 'none';
                
                // Start auto-refresh
                setInterval(loadHighestBids, 10000); // Refresh every 10 seconds
                
            } catch (error) {
                console.error('Error loading auction data:', error);
                showStatus('Error loading auction data', 'error');
            }
        }
        
        // Load highest bids from backend
        async function loadHighestBids() {
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/auction-highest-bids`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        highestBids = result.highestBids;
                        updateBidDisplays();
                    }
                }
            } catch (error) {
                console.error('Error loading highest bids:', error);
            }
        }
        
        // Render auction items
        function renderAuctionItems() {
            const grid = document.getElementById('auctionGrid');
            grid.innerHTML = '';
            
            AUCTION_ITEMS.forEach(item => {
                const itemElement = createAuctionItemElement(item);
                grid.appendChild(itemElement);
            });
        }
        
        // Create auction item element
        function createAuctionItemElement(item) {
            const div = document.createElement('div');
            div.className = 'auction-item';
            div.id = `item-${item.itemId}`;
            
            const highestBid = highestBids[item.itemId] || { bid_amount: 0, username: null };
            const currentBid = Math.max(highestBid.bid_amount || 0, item.reserveBid);
            const minimumBid = currentBid + 0.5; // Minimum increment of 0.5 Pi
            
            div.innerHTML = `
                <div class="artist-name">${item.artistName}</div>
                <div class="artwork-title">${item.artworkTitle}</div>
                <div class="reserve-bid">Reserve: ${item.reserveBid} π</div>
                
                <img src="${item.imagePath}" alt="${item.artworkTitle}" class="artwork-image" 
                     onerror="this.src='images/placeholder.png'">
                
                <div class="current-bid" id="currentBid-${item.itemId}">
                    Current Bid: ${currentBid} π
                </div>
                
                <div class="highest-bidder" id="highestBidder-${item.itemId}">
                    ${highestBid.username ? `Highest Bidder: ${highestBid.username}` : 'No bids yet'}
                </div>
                
                <input type="number" class="bid-input" id="bidInput-${item.itemId}" 
                       placeholder="Enter bid amount" 
                       min="${minimumBid}" 
                       step="0.5"
                       ${!piUser ? 'disabled' : ''}>
                
                <button class="bid-button" onclick="submitBid('${item.itemId}')" 
                        ${!piUser ? 'disabled' : ''}>
                    ${piUser ? 'Place Bid' : 'Login to Bid'}
                </button>
            `;
            
            return div;
        }
        
        // Update bid displays
        function updateBidDisplays() {
            AUCTION_ITEMS.forEach(item => {
                const highestBid = highestBids[item.itemId] || { bid_amount: 0, username: null };
                const currentBid = Math.max(highestBid.bid_amount || 0, item.reserveBid);
                const minimumBid = currentBid + 0.5;
                
                const currentBidElement = document.getElementById(`currentBid-${item.itemId}`);
                const highestBidderElement = document.getElementById(`highestBidder-${item.itemId}`);
                const bidInputElement = document.getElementById(`bidInput-${item.itemId}`);
                
                if (currentBidElement) {
                    currentBidElement.textContent = `Current Bid: ${currentBid} π`;
                }
                
                if (highestBidderElement) {
                    highestBidderElement.textContent = highestBid.username ? 
                        `Highest Bidder: ${highestBid.username}` : 'No bids yet';
                }
                
                if (bidInputElement) {
                    bidInputElement.min = minimumBid;
                    bidInputElement.placeholder = `Min: ${minimumBid} π`;
                }
            });
        }
        
        // Submit bid
        async function submitBid(itemId) {
            if (!piUser) {
                alert('Please authenticate with Pi Network first');
                return;
            }
            
            const bidInput = document.getElementById(`bidInput-${itemId}`);
            const bidAmount = parseFloat(bidInput.value);
            
            if (!bidAmount || bidAmount <= 0) {
                alert('Please enter a valid bid amount');
                return;
            }
            
            const highestBid = highestBids[itemId] || { bid_amount: 0 };
            const item = AUCTION_ITEMS.find(i => i.itemId === itemId);
            const currentBid = Math.max(highestBid.bid_amount || 0, item.reserveBid);
            const minimumBid = currentBid + 0.5;
            
            if (bidAmount < minimumBid) {
                alert(`Bid must be at least ${minimumBid} π`);
                return;
            }
            
            try {
                showStatus('Submitting bid...', 'loading');
                
                // Submit bid to backend
                const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/auction-bid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: piUser.username,
                        userUid: piUser.uid,
                        itemId: itemId,
                        bidAmount: bidAmount
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showStatus('Bid submitted successfully!', 'success');
                        bidInput.value = '';
                        
                        // Refresh bid data
                        await loadHighestBids();
                        
                        setTimeout(() => {
                            document.getElementById('statusMessage').style.display = 'none';
                        }, 3000);
                    } else {
                        throw new Error(result.error || 'Failed to submit bid');
                    }
                } else {
                    throw new Error('Server error');
                }
                
            } catch (error) {
                console.error('Error submitting bid:', error);
                showStatus('Error submitting bid: ' + error.message, 'error');
                
                setTimeout(() => {
                    document.getElementById('statusMessage').style.display = 'none';
                }, 5000);
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
        }
    </script>
</body>
</html>
