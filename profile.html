<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile - Appraisells</title>
  
  <!-- Pi SDK - Load first -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <!-- Configuration script -->
  <script src="script.js"></script>
    
  <link rel="stylesheet" href="style.css" />
  
  <style>
    header {
      background-color: #030006;
      padding: 20px 0;
    }

    header h1 {
      margin: 0;
      font-size: 3.5em;
      color: white;
      text-align: center;
    }

    body { 
      background-color: white;
    }

    /* Force subscription state display */
    .subscription-active {
      display: block !important;
      visibility: visible !important;
    }
    
    .subscription-hidden {
      display: none !important;
      visibility: hidden !important;
    }
    
    .auction-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 40px 0;
    }
    
    .auction-image {
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .auction-image:hover {
      transform: scale(1.05);
    }
  </style>
 </head>

 <body>
  <header>
    <h1>APPRAISELLS</h1>
  </header>

  <div id="userInfo" style="margin: 30px 0; font-size: 1.2em; text-align: center;"></div>
  <div id="walletInfo" style="margin: 10px 0; font-size: 1.1em; text-align: center;"></div>

  <!-- Subscription Status Text (hidden by default) -->
  <div id="subscriptionText" style="display: none; text-align: center; margin: 20px 0; font-size: 1.2em; color: #030006; font-weight: 500;">
    Enjoy Appraisells auctions
  </div>

  <!-- Subscribe Button (shown only if no active subscription) -->
  <div id="subscribeSection" style="text-align: center; margin: 20px 0;">
    <button onclick="subscribe()" id="subscribeBtn" style="padding:12px 25px; font-size:2rem; background-color:#030006; color: white; border:none; border-radius:8px; cursor:pointer;">Subscribe</button>
  </div>

  <!-- Auction Container -->
  <div class="auction-container" onclick="window.location.href='liveAuction.html'" style="cursor: pointer;">
    <span style="font-size:1.5em; color: rgb(7, 7, 7); margin-bottom:16px;">Auction 1</span>
    <img src="images/middle finger man.png" alt="Appraisal" class="auction-image" style="height:240px; width:240px; object-fit:cover; border:1px solid #fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.10);">
  </div>

  <!-- Logout Button -->
  <div style="text-align: center; margin-top: 40px;">
    <button onclick="logout()" id="logoutBtn" style="padding:12px 25px; font-size:2rem; background-color:#030006; color: white; border:none; border-radius:8px; cursor:pointer;">Log Out</button>
  </div>

  <!-- Debug Information Section -->
  <div id="debugInfo" style="margin-top: 30px; padding: 15px; background: #f0f0f0; border-radius: 8px; font-family: monospace; font-size: 12px;">
    <strong>üîç Profile Debug Information:</strong><br>
    <div id="debugContent"></div>
    <!-- Test Backend Connection -->
    <button onclick="testBackendConnection()" style="background: #007bff; color: white; padding: 8px 15px; margin: 10px 0; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
      Test Backend Connection
    </button>
  </div>

  <script>
    let piUser = null; // Will hold the authenticated Pi user
    
    // Debug function
    function addDebugInfo(message) {
      const debugContent = document.getElementById('debugContent');
      const timestamp = new Date().toLocaleTimeString();
      debugContent.innerHTML += `[${timestamp}] ${message}<br>`;
      console.log(`[PROFILE DEBUG] ${message}`);
    }
    
    // Initialize debug info
    addDebugInfo('üîÑ Profile page loaded');
    addDebugInfo(`Backend URL: ${CONFIG.BACKEND_URL}`);
    addDebugInfo(`User Agent: ${navigator.userAgent}`);
    
    if (navigator.userAgent.includes('Pi Browser') || navigator.userAgent.includes('iPhone')) {
      addDebugInfo('‚úÖ Pi Browser detected');
    } else {
      addDebugInfo('‚ö†Ô∏è Not Pi Browser - authentication may not work');
    }

    // Test backend connection
    async function testBackendConnection() {
      addDebugInfo('=== BACKEND CONNECTION TEST ===');
      
      try {
        addDebugInfo('Testing API health endpoint...');
        
        const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/health`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          addDebugInfo(`‚úÖ Backend connected: ${result.status || 'OK'}`);
        } else {
          addDebugInfo(`‚ùå Backend test failed: ${response.status}`);
        }
        
      } catch (error) {
        addDebugInfo(`‚ùå Backend connection error: ${error.message}`);
      }
      
      addDebugInfo('=== TEST COMPLETE ===');
    }

    function logout() {
      piUser = null;
      window.location.href = "index.html";
    }

    function subscribe() {
      // Use authenticated Pi user for subscription
      if (!piUser) {
        addDebugInfo('‚ùå Subscribe clicked but no piUser available');
        alert('Please authenticate with Pi Network first');
        return;
      }
      
      addDebugInfo(`üîÑ Redirecting to subscription payment for: ${piUser.username}`);
      
      // Redirect to auctionPayment.html with Pi user parameters
      let redirectUrl = "auctionPayment.html";
      redirectUrl += `?username=${encodeURIComponent(piUser.username)}`;
      if (piUser.wallet) {
        redirectUrl += `&wallet=${encodeURIComponent(piUser.wallet)}`;
      }
      
      addDebugInfo(`üîó Redirect URL: ${redirectUrl}`);
      window.location.href = redirectUrl;
    }

    // Authenticate with Pi Network and load user profile
    async function authenticateAndLoadProfile() {
      try {
        addDebugInfo('üîê Starting Pi Network authentication...');
        console.log('üîê Starting Pi Network authentication...');
        
        // Check if Pi SDK is available
        if (typeof Pi === 'undefined') {
          throw new Error('Pi SDK not loaded. Please open this app in Pi Browser.');
        }
        
        addDebugInfo('‚úÖ Pi SDK detected');
        
        // Initialize Pi SDK
        Pi.init({
          version: "2.0",
          sandbox: true // Set to true for testnet
        });
        
        addDebugInfo('‚úÖ Pi SDK initialized');
        console.log('üîê Pi SDK initialized, authenticating user...');
        
        // Authenticate user with Pi Network
        const auth = await Pi.authenticate(['username', 'payments']);
        piUser = auth.user;
        
        addDebugInfo(`‚úÖ Pi Network authentication successful! User: ${piUser.username}`);
        addDebugInfo(`üîç User UID: ${piUser.uid}`);
        addDebugInfo(`üîç User wallet: ${piUser.wallet || 'Not provided'}`);
        console.log(`‚úÖ Pi Network authentication successful! User: ${piUser.username}`);
        console.log('Full Pi user object:', piUser);
        
        // Store user in localStorage for other pages
        localStorage.setItem('currentUser', JSON.stringify({
          username: piUser.username,
          uid: piUser.uid,
          wallet: piUser.wallet
        }));
        
        // Display user information
        const userInfoElement = document.getElementById("userInfo");
        if (userInfoElement) {
          userInfoElement.innerHTML = `<strong>Username:</strong> ${piUser.username}`;
        } else {
          addDebugInfo('‚ùå ERROR: userInfo element not found!');
        }
        
        const walletInfoElement = document.getElementById("walletInfo");
        if (walletInfoElement && piUser.wallet) {
          walletInfoElement.innerHTML = `<strong>Wallet:</strong> ${piUser.wallet}`;
        }
        
        addDebugInfo('üîÑ Creating/updating user profile in backend...');
        
        // Create/update user profile in backend
        await createUserProfileIfNeeded(piUser.username, piUser.wallet, piUser.uid);
        
        addDebugInfo('üîÑ Checking subscription status and updating UI...');
        
        // Check subscription status for authenticated user and update UI accordingly
        await checkSubscriptionStatusAndUpdateUI(piUser.username);
        
      } catch (error) {
        addDebugInfo(`‚ùå Pi Network authentication failed: ${error.message}`);
        console.error('‚ùå Pi Network authentication failed:', error);
        showAuthenticationError();
      }
    }

    // Show authentication error state
    function showAuthenticationError() {
      addDebugInfo('üîÑ Showing authentication error state...');
      console.log('üîÑ Showing authentication error state...');
      
      // Show error message to user
      document.getElementById("userInfo").innerHTML = `
        <div style="color: red; text-align: center; margin: 20px;">
          <strong>Authentication Required</strong><br>
          Please open this app in Pi Browser and allow authentication.
        </div>
      `;
      
      // Hide subscription text
      document.getElementById('subscriptionText').style.display = 'none';
      
      // Show login button instead of subscribe button
      document.getElementById('subscribeSection').innerHTML = `
        <div style="text-align: center; margin: 20px 0;">
          <button onclick="authenticateAndLoadProfile()" style="padding:12px 25px; font-size:1.5rem; background-color:#030006; color: white; border:none; border-radius:8px; cursor:pointer;">
            Login with Pi Network
          </button>
        </div>
      `;
      
      addDebugInfo('‚úÖ Authentication error UI displayed');
    }

    // Show subscription state based on user's subscription status
    function showSubscriptionState(hasActiveSubscription, subscriptionData = null) {
      addDebugInfo(`üéØ Updating UI state - hasActiveSubscription: ${hasActiveSubscription}`);
      console.log(`üéØ Updating UI state - hasActiveSubscription: ${hasActiveSubscription}`);
      
      const subscriptionTextElement = document.getElementById('subscriptionText');
      const subscribeSectionElement = document.getElementById('subscribeSection');
      
      if (hasActiveSubscription) {
        // User HAS active subscription - show "Enjoy Appraisells auctions" text
        addDebugInfo('‚úÖ Showing SUBSCRIBED state - "Enjoy Appraisells auctions"');
        console.log('‚úÖ Showing SUBSCRIBED state - "Enjoy Appraisells auctions"');
        
        if (subscriptionData) {
          addDebugInfo(`üìã Subscription details: End date: ${subscriptionData.endDate}, Days remaining: ${subscriptionData.daysRemaining}`);
        }
        
        // Reset the subscribe section to original button
        subscribeSectionElement.innerHTML = `
          <button onclick="subscribe()" id="subscribeBtn" style="padding:12px 25px; font-size:2rem; background-color:#030006; color: white; border:none; border-radius:8px; cursor:pointer;">Subscribe</button>
        `;
        
        // Show subscription text, hide subscribe button
        subscriptionTextElement.style.display = 'block';
        subscriptionTextElement.style.visibility = 'visible';
        subscriptionTextElement.className = 'subscription-active';
        
        subscribeSectionElement.style.display = 'none';
        subscribeSectionElement.style.visibility = 'hidden';
        subscribeSectionElement.className = 'subscription-hidden';
        
        addDebugInfo('üéâ SUBSCRIBED USER: Should see "Enjoy Appraisells auctions"');
        
      } else {
        // User has NO active subscription - show Subscribe button
        addDebugInfo('‚ùå Showing UNSUBSCRIBED state - Subscribe button');
        console.log('‚ùå Showing UNSUBSCRIBED state - Subscribe button');
        
        // Reset the subscribe section to original button
        subscribeSectionElement.innerHTML = `
          <button onclick="subscribe()" id="subscribeBtn" style="padding:12px 25px; font-size:2rem; background-color:#030006; color: white; border:none; border-radius:8px; cursor:pointer;">Subscribe</button>
        `;
        
        // Hide subscription text, show subscribe button
        subscriptionTextElement.style.display = 'none';
        subscriptionTextElement.style.visibility = 'hidden';
        subscriptionTextElement.className = 'subscription-hidden';
        
        subscribeSectionElement.style.display = 'block';
        subscribeSectionElement.style.visibility = 'visible';
        subscribeSectionElement.className = 'subscription-active';
        
        addDebugInfo('üí≥ UNSUBSCRIBED USER: Should see Subscribe button');
      }
    }

    // Create user profile in backend if it doesn't exist
    async function createUserProfileIfNeeded(username, wallet, userUid) {
      try {
        addDebugInfo(`üîÑ Ensuring user profile exists for: ${username}`);
        
        const response = await fetch(`${CONFIG.BACKEND_URL}/api.php`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            endpoint: 'save-user',
            username: username,
            wallet: wallet,
            uid: userUid
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          addDebugInfo(`‚úÖ User profile ready for: ${username}`);
        } else {
          addDebugInfo(`‚ö†Ô∏è Profile creation failed: ${response.status}`);
        }
        
      } catch (error) {
        addDebugInfo(`‚ùå Failed to create user profile: ${error.message}`);
      }
    }

    // Check subscription status and update UI accordingly
    async function checkSubscriptionStatusAndUpdateUI(username) {
      try {
        addDebugInfo(`üîç Starting subscription check for: ${username}`);
        
        const url = `${CONFIG.BACKEND_URL}/api.php/subscription-status/${encodeURIComponent(username)}`;
        addDebugInfo(`üì° Fetching from: ${url}`);
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        addDebugInfo(`üì¨ Response status: ${response.status}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        addDebugInfo(`üìä Subscription result: ${JSON.stringify(result)}`);
        
        // Use the new UI management function
        if (result.success && result.hasActiveSubscription) {
          addDebugInfo(`‚úÖ ${username} HAS ACTIVE SUBSCRIPTION!`);
          showSubscriptionState(true, result.subscription);
        } else {
          addDebugInfo(`‚ùå ${username} has no active subscription`);
          showSubscriptionState(false, result);
        }
        
      } catch (error) {
        addDebugInfo(`‚ùå Failed to check subscription status: ${error.message}`);
        console.error('‚ùå Failed to check subscription status:', error);
        
        // On error, show unsubscribed state (safe default)
        addDebugInfo(`‚ö†Ô∏è Error occurred - showing unsubscribed state as default`);
        showSubscriptionState(false);
      }
    }

    // Initialize page with Pi Network authentication
    window.addEventListener('load', function() {
      addDebugInfo('üîÑ Profile page loaded - starting Pi Network authentication...');
      console.log('üîÑ Profile page loaded - starting Pi Network authentication...');
      
      // Hide both elements initially
      document.getElementById('subscriptionText').style.display = 'none';
      document.getElementById('subscribeSection').style.display = 'none';
      addDebugInfo('üîÑ Initial UI elements hidden');
      
      // Start Pi Network authentication
      authenticateAndLoadProfile();
    });
  </script>
</body>
</html>
    
    // Debug function
    function addDebugInfo(message) {
      if (!debugMode) return;
      
      const debugSection = document.getElementById('debugSection');
      const debugContent = document.getElementById('debugContent');
      debugSection.style.display = 'block';
      
      const timestamp = new Date().toLocaleTimeString();
      debugContent.innerHTML += `[${timestamp}] ${message}\n`;
      console.log(`[PROFILE DEBUG] ${message}`);
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      addDebugInfo('üîÑ Profile page loaded');
      addDebugInfo(`Backend URL: ${CONFIG.BACKEND_URL}`);
      addDebugInfo(`User Agent: ${navigator.userAgent}`);
      
      if (navigator.userAgent.includes('Pi Browser') || navigator.userAgent.includes('iPhone')) {
        addDebugInfo('‚úÖ Pi Browser detected');
      } else {
        addDebugInfo('‚ö†Ô∏è Not Pi Browser - authentication may work anyway');
      }
      
      // Test backend connection and then authenticate
      testBackendConnection().then(() => {
        authenticateUser();
      });
    });
    
    // Test backend connection
    async function testBackendConnection() {
      addDebugInfo('=== BACKEND CONNECTION TEST ===');
      
      try {
        addDebugInfo('Testing health endpoint...');
        
        const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/health`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          addDebugInfo(`‚úÖ Backend connected: ${result.status}`);
          addDebugInfo(`Database: ${result.databaseConnected ? 'Connected' : 'Disconnected'}`);
          addDebugInfo(`Pi API Key: ${result.piApiKeySet ? 'Set' : 'Not Set'}`);
        } else {
          addDebugInfo(`‚ùå Backend test failed: ${response.status}`);
        }
        
      } catch (error) {
        addDebugInfo(`‚ùå Backend connection error: ${error.message}`);
      }
    }
    
    // Authenticate user with Pi Network
    async function authenticateUser() {
      addDebugInfo('=== PI AUTHENTICATION ===');
      
      try {
        addDebugInfo('Starting Pi authentication...');
        
        // Authenticate with Pi Network
        const auth = await Pi.authenticate(['username', 'payments'], onIncompletePaymentFound);
        
        piUser = auth.user;
        addDebugInfo(`‚úÖ Authentication successful for user: ${piUser.username}`);
        
        // Log authentication to backend
        await logAuthentication(piUser.username, piUser.uid, true);
        
        // Create/update user profile
        await createUserProfile(piUser.username, piUser.uid);
        
        // Check subscription status
        await checkSubscriptionStatus(piUser.username);
        
      } catch (error) {
        addDebugInfo(`‚ùå Pi authentication failed: ${error.message}`);
        
        // Log failed authentication
        await logAuthentication('unknown', 'unknown', false);
        
        // Show error to user
        alert('Authentication failed. Please make sure you\'re using the Pi Browser.');
      }
    }
    
    // Handle incomplete payments
    function onIncompletePaymentFound(payment) {
      addDebugInfo(`Found incomplete payment: ${payment.identifier}`);
      // You can handle incomplete payments here
      return Pi.completePayment(payment.identifier);
    }
    
    // Log authentication to backend
    async function logAuthentication(username, userUid, authSuccess) {
      try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/log-authentication`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: username,
            userUid: userUid,
            authSuccess: authSuccess
          })
        });
        
        if (response.ok) {
          addDebugInfo('‚úÖ Authentication logged successfully');
        } else {
          addDebugInfo('‚ùå Failed to log authentication');
        }
        
      } catch (error) {
        addDebugInfo(`‚ùå Error logging authentication: ${error.message}`);
      }
    }
    
    // Create/update user profile
    async function createUserProfile(username, userUid) {
      try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/create-user-profile`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: username,
            userUid: userUid
          })
        });
        
        if (response.ok) {
          addDebugInfo('‚úÖ User profile created/updated');
        } else {
          addDebugInfo('‚ùå Failed to create user profile');
        }
        
      } catch (error) {
        addDebugInfo(`‚ùå Error creating user profile: ${error.message}`);
      }
    }
    
    // Check subscription status
    async function checkSubscriptionStatus(username) {
      try {
        addDebugInfo('Checking subscription status...');
        
        const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/subscription-status/${encodeURIComponent(username)}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success && result.hasActiveSubscription) {
            showSubscriptionActive();
            addDebugInfo('‚úÖ Active subscription found');
          } else {
            showSubscriptionInactive();
            addDebugInfo('‚ùå No active subscription');
          }
        } else {
          addDebugInfo('‚ùå Failed to check subscription status');
          showSubscriptionInactive();
        }
        
      } catch (error) {
        addDebugInfo(`‚ùå Error checking subscription: ${error.message}`);
        showSubscriptionInactive();
      }
    }
    
    // Show subscription active state
    function showSubscriptionActive() {
      document.getElementById('subscriptionText').style.display = 'block';
      document.getElementById('subscribeSection').style.display = 'none';
    }
    
    // Show subscription inactive state
    function showSubscriptionInactive() {
      document.getElementById('subscriptionText').style.display = 'none';
      document.getElementById('subscribeSection').style.display = 'block';
    }
    
    // Subscribe function
    async function subscribe() {
      if (!piUser) {
        alert('Please authenticate first');
        return;
      }
      
      addDebugInfo('=== SUBSCRIPTION PAYMENT ===');
      
      try {
        addDebugInfo('Creating payment...');
        
        // Create payment with Pi Network
        const payment = await Pi.createPayment({
          amount: CONFIG.PAYMENT.amount,
          memo: CONFIG.PAYMENT.memo,
          metadata: {
            ...CONFIG.PAYMENT.defaultMetadata,
            username: piUser.username,
            userUid: piUser.uid,
            paymentType: 'subscription'
          }
        }, {
          onReadyForServerApproval: function(paymentId) {
            addDebugInfo(`Payment created: ${paymentId}`);
            approvePayment(paymentId);
          },
          onReadyForServerCompletion: function(paymentId, txId) {
            addDebugInfo(`Payment ready for completion: ${paymentId}, ${txId}`);
            completePayment(paymentId, txId);
          },
          onCancel: function(paymentId) {
            addDebugInfo(`Payment cancelled: ${paymentId}`);
          },
          onError: function(error, payment) {
            addDebugInfo(`Payment error: ${error.message}`);
            alert('Payment failed: ' + error.message);
          }
        });
        
      } catch (error) {
        addDebugInfo(`‚ùå Payment creation failed: ${error.message}`);
        alert('Failed to create payment: ' + error.message);
      }
    }
    
    // Approve payment on backend
    async function approvePayment(paymentId) {
      try {
        addDebugInfo(`Approving payment: ${paymentId}`);
        
        const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/approve-payment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            paymentId: paymentId
          })
        });
        
        if (response.ok) {
          addDebugInfo('‚úÖ Payment approved on backend');
        } else {
          addDebugInfo('‚ùå Payment approval failed on backend');
        }
        
      } catch (error) {
        addDebugInfo(`‚ùå Error approving payment: ${error.message}`);
      }
    }
    
    // Complete payment on backend
    async function completePayment(paymentId, txId) {
      try {
        addDebugInfo(`Completing payment: ${paymentId} with tx: ${txId}`);
        
        const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/complete-payment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            paymentId: paymentId,
            txId: txId
          })
        });
        
        if (response.ok) {
          addDebugInfo('‚úÖ Payment completed successfully');
          alert('Subscription activated! Thank you for your payment.');
          
          // Refresh subscription status
          if (piUser) {
            await checkSubscriptionStatus(piUser.username);
          }
        } else {
          addDebugInfo('‚ùå Payment completion failed on backend');
        }
        
      } catch (error) {
        addDebugInfo(`‚ùå Error completing payment: ${error.message}`);
      }
    }
    
    // Logout function
    function logout() {
      piUser = null;
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>