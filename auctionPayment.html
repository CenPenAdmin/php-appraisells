<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscribe to Appraisells</title>
    <!-- Configuration -->
    <script src="script.js"></script>
    <!-- Pi SDK -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        header {
            background-color: #030006;
            padding: 20px 0;
        }

        header h1 {
            margin: 0;
            font-size: 3.5em;
            color: white;
            text-align: center;
        }

        body {
            background-color: white;
            font-family: Arial, sans-serif;
        }

        .subscription-info {
            text-align: center;
            padding: 20px;
            margin: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .payment-section {
            text-align: center;
            margin: 20px;
        }

        .debug-section {
            margin-top: 20px;
            padding: 10px;
            background: #f0f0f0;
            font-family: monospace;
            font-size: 12px;
            border-radius: 8px;
        }

        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }

        .pay-button {
            background: #007bff;
            color: white;
        }

        .nav-button {
            background: #030006;
            color: white;
        }

        .test-button {
            background: #28a745;
            color: white;
            font-size: 1em;
            padding: 10px 15px;
        }
    </style>
</head>
<body>
    <!-- BANNER -->
    <header>
        <h1>Subscribe to Appraisells</h1>
    </header>

    <div class="subscription-info">
        <h2 style="color: #030006;">30-Day Subscription</h2>
        <p style="font-size: 1.1em; margin: 10px 0;">Get unlimited access to all non-appraised auctions for 30 days</p>
        <p style="font-size: 1em; color: #666;">✓ Browse all auction items<br>✓ Place bids on items<br>✓ Participate in live auctions</p>
        <p style="font-size: 1.2em; font-weight: bold; color: #030006;">Only 1 Pi Coin</p>
    </div>
    
    <!-- Pi Authentication Button (hidden by default since user is already authenticated) -->
    <div style="text-align: center;">
        <button id="signinButton" onclick="signIn()" style="display: none;" class="nav-button">Click To Allow Payment Creation</button>
    </div>

    <div id="paymentSection" style="display: none;" class="payment-section">
        <p id="userInfo">Loading user information...</p>
        <button id="payButton" onclick="makePayment()" class="pay-button">Pay 1 Pi for 30-Day Subscription</button>
        <p id="paymentStatus"></p>
    </div>

    <!-- Test Backend Connection -->
    <div style="text-align: center;">
        <button onclick="testBackend()" class="test-button">Test Backend Connection</button>
    </div>

    <div class="debug-section">
        <strong>Debug Information:</strong><br>
        <div id="debugContent"></div>
    </div>

    <script>
        let piUser = null;
        
        // Debug function
        function addDebugInfo(message) {
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString();
            debugContent.innerHTML += `[${timestamp}] ${message}<br>`;
            console.log(`[DEBUG] ${message}`);
        }
        
        // Initialize Pi SDK
        addDebugInfo('Initializing Pi SDK...');
        
        // Check if Pi SDK loaded properly
        if (typeof Pi === 'undefined') {
            addDebugInfo('❌ Pi SDK not loaded! Make sure you are using Pi Browser.');
            alert('Error: Pi SDK not detected. Please open this app in Pi Browser.');
        } else {
            addDebugInfo('✅ Pi SDK loaded successfully');
            
            Pi.init({
                version: "2.0",
                sandbox: true
            });
            addDebugInfo(`Pi SDK initialized - Version: 2.0, Sandbox: true`);
        }
        
        addDebugInfo(`Backend URL: ${CONFIG.BACKEND_URL}`);
        
        // Check browser environment
        const userAgent = navigator.userAgent;
        addDebugInfo(`Browser: ${userAgent}`);
        
        if (userAgent.includes('Pi Browser') || userAgent.includes('iPhone')) {
            addDebugInfo('✅ Pi Browser detected');
        } else {
            addDebugInfo('⚠️ Not Pi Browser - authentication may not work');
        }

        // Test backend connection
        async function testBackend() {
            addDebugInfo('=== BACKEND CONNECTION TEST ===');
            
            try {
                addDebugInfo('Testing API health endpoint...');
                
                const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addDebugInfo(`✅ Health test successful: ${result.status || 'OK'}`);
                } else {
                    addDebugInfo(`❌ Health test failed: ${response.status} ${response.statusText}`);
                }
                
            } catch (error) {
                addDebugInfo(`❌ Health test error: ${error.message}`);
            }
            
            addDebugInfo('=== TEST COMPLETE ===');
        }

        // Load user credentials from URL parameters (passed from profile.html)
        function loadUserFromParams() {
            const params = new URLSearchParams(window.location.search);
            const username = params.get('username');
            const wallet = params.get('wallet');
            
            if (username) {
                // User credentials available from profile.html
                piUser = {
                    username: username,
                    wallet: wallet,
                    uid: 'from_profile' // We'll get the real UID if needed
                };
                
                addDebugInfo(`✅ User loaded from profile: ${username}`);
                
                // Update UI with user information
                document.getElementById('userInfo').innerHTML = `
                    <strong>Welcome, ${piUser.username}!</strong><br>
                    ${wallet ? `<small>Wallet: ${wallet}</small>` : ''}
                `;
                
                // Show payment section since user is authenticated
                document.getElementById('paymentSection').style.display = 'block';
                document.getElementById('signinButton').style.display = 'none';
                
                addDebugInfo('Payment section ready - user authenticated from profile');
                return true;
            } else {
                addDebugInfo('⚠️ No user credentials in URL - showing sign in button');
                // Show sign in button if no credentials
                document.getElementById('signinButton').style.display = 'block';
                document.getElementById('paymentSection').style.display = 'none';
                return false;
            }
        }

        // Check if user already has active subscription
        async function checkSubscriptionStatus() {
            if (!piUser || !piUser.username) {
                addDebugInfo('No user available for subscription check');
                return;
            }
            
            try {
                addDebugInfo(`Checking subscription status for: ${piUser.username}`);
                
                const response = await fetch(`${CONFIG.BACKEND_URL}/api.php/subscription-status/${encodeURIComponent(piUser.username)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                addDebugInfo(`Subscription check result: ${JSON.stringify(result)}`);
                
                if (result.success && result.hasActiveSubscription) {
                    // User already has active subscription
                    showAlreadySubscribed(result.subscription);
                } else {
                    // User needs to subscribe - show payment section
                    addDebugInfo('User needs subscription - showing payment option');
                    document.getElementById('paymentSection').style.display = 'block';
                }
                
            } catch (error) {
                addDebugInfo(`Subscription check failed: ${error.message}`);
                console.error('Subscription check error:', error);
                // On error, show payment section (safe default)
                document.getElementById('paymentSection').style.display = 'block';
            }
        }
        
        // Show already subscribed message
        function showAlreadySubscribed(subscription) {
            const endDate = subscription ? subscription.end_date : 'Unknown';
            const daysRemaining = subscription ? subscription.daysRemaining : 0;
            
            document.getElementById('paymentSection').innerHTML = `
                <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;">
                    <h3 style="color: #155724; margin: 0 0 15px 0;">✅ You're Already Subscribed!</h3>
                    <p style="margin: 10px 0; font-size: 1.1em;">You have an active 30-day subscription.</p>
                    <p style="margin: 10px 0;"><strong>Subscription valid until:</strong> ${endDate}</p>
                    <p style="margin: 10px 0; color: #28a745;"><strong>${daysRemaining} days remaining</strong></p>
                    <p style="margin: 15px 0; font-size: 0.9em; color: #666;">You can bid on all non-appraised auctions!</p>
                    <button onclick="returnToProfile()" class="nav-button">
                        Return to Profile
                    </button>
                </div>
            `;
            document.getElementById('paymentSection').style.display = 'block';
            addDebugInfo('✅ Already subscribed message shown');
        }

        // Return to profile with user parameters
        function returnToProfile() {
            let profileUrl = 'profile.html';
            if (piUser && piUser.username) {
                profileUrl += `?username=${encodeURIComponent(piUser.username)}`;
                if (piUser.wallet) {
                    profileUrl += `&wallet=${encodeURIComponent(piUser.wallet)}`;
                }
            }
            window.location.href = profileUrl;
        }

        // Initialize page - try to load user from URL params first
        window.addEventListener('load', function() {
            addDebugInfo('Page loaded - checking for user credentials...');
            
            if (loadUserFromParams()) {
                // User loaded from params, now check subscription status
                checkSubscriptionStatus();
            } else {
                addDebugInfo('User not pre-authenticated - sign in required');
            }
        });

        // Sign in function (only used if user wasn't pre-authenticated)
        async function signIn() {
            try {
                addDebugInfo('Starting Pi authentication...');
                
                // Check if Pi SDK is available
                if (typeof Pi === 'undefined') {
                    throw new Error('Pi SDK not loaded. Make sure you are using Pi Browser.');
                }
                
                addDebugInfo('Pi SDK detected. Starting authentication...');
                
                // Authenticate user with Pi Network
                const auth = await Pi.authenticate(['username', 'payments'], onIncompletePaymentFound);
                piUser = auth.user;
                
                addDebugInfo(`✅ Authentication successful! User: ${piUser.username}`);
                
                // Update UI
                document.getElementById('userInfo').innerHTML = `
                    <strong>Welcome, ${piUser.username}!</strong><br>
                    ${piUser.wallet ? `<small>Wallet: ${piUser.wallet}</small>` : ''}
                `;
                
                document.getElementById('paymentSection').style.display = 'block';
                document.getElementById('signinButton').style.display = 'none';
                
                // Check subscription status
                await checkSubscriptionStatus();
                
            } catch (error) {
                addDebugInfo(`❌ Authentication failed: ${error.message}`);
                alert('Authentication failed. Please try again or check if you\'re using Pi Browser.');
            }
        }

        // Handle incomplete payments
        function onIncompletePaymentFound(payment) {
            addDebugInfo(`Found incomplete payment: ${payment.identifier}`);
            return Pi.completePayment(payment.identifier);
        }

        // Make subscription payment
        async function makePayment() {
            if (!piUser) {
                alert('Please authenticate first');
                return;
            }
            
            addDebugInfo('=== CREATING SUBSCRIPTION PAYMENT ===');
            
            try {
                addDebugInfo('Creating Pi payment...');
                document.getElementById('paymentStatus').innerHTML = 'Creating payment...';
                
                // Create payment with Pi Network
                const payment = await Pi.createPayment({
                    amount: 1,
                    memo: "Appraisells 30-day subscription",
                    metadata: {
                        itemName: "30-Day Subscription",
                        username: piUser.username,
                        userUid: piUser.uid,
                        paymentType: 'subscription'
                    }
                }, {
                    onReadyForServerApproval: function(paymentId) {
                        addDebugInfo(`Payment created: ${paymentId}`);
                        document.getElementById('paymentStatus').innerHTML = 'Payment created, approving...';
                        approvePayment(paymentId);
                    },
                    onReadyForServerCompletion: function(paymentId, txId) {
                        addDebugInfo(`Payment ready for completion: ${paymentId}, ${txId}`);
                        document.getElementById('paymentStatus').innerHTML = 'Completing payment...';
                        completePayment(paymentId, txId);
                    },
                    onCancel: function(paymentId) {
                        addDebugInfo(`Payment cancelled: ${paymentId}`);
                        document.getElementById('paymentStatus').innerHTML = 'Payment cancelled';
                    },
                    onError: function(error, payment) {
                        addDebugInfo(`Payment error: ${error.message}`);
                        document.getElementById('paymentStatus').innerHTML = 'Payment failed: ' + error.message;
                        alert('Payment failed: ' + error.message);
                    }
                });
                
            } catch (error) {
                addDebugInfo(`❌ Payment creation failed: ${error.message}`);
                document.getElementById('paymentStatus').innerHTML = 'Payment creation failed: ' + error.message;
                alert('Failed to create payment: ' + error.message);
            }
        }

        // Approve payment on backend
        async function approvePayment(paymentId) {
            try {
                addDebugInfo(`Approving payment: ${paymentId}`);
                
                const response = await fetch(`${CONFIG.BACKEND_URL}/api.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        endpoint: 'approve-subscription-payment',
                        paymentId: paymentId,
                        username: piUser.username,
                        userUid: piUser.uid
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addDebugInfo('✅ Payment approved on backend');
                } else {
                    addDebugInfo('❌ Payment approval failed on backend');
                }
                
            } catch (error) {
                addDebugInfo(`❌ Error approving payment: ${error.message}`);
            }
        }

        // Complete payment on backend
        async function completePayment(paymentId, txId) {
            try {
                addDebugInfo(`Completing payment: ${paymentId} with tx: ${txId}`);
                
                const response = await fetch(`${CONFIG.BACKEND_URL}/api.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        endpoint: 'complete-subscription-payment',
                        paymentId: paymentId,
                        txId: txId,
                        username: piUser.username,
                        userUid: piUser.uid
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addDebugInfo('✅ Payment completed successfully');
                    document.getElementById('paymentStatus').innerHTML = 
                        '<div style="color: green; font-weight: bold;">✅ Subscription activated! Thank you for your payment.</div>';
                    
                    // Redirect to profile after short delay
                    setTimeout(() => {
                        returnToProfile();
                    }, 3000);
                } else {
                    addDebugInfo('❌ Payment completion failed on backend');
                    document.getElementById('paymentStatus').innerHTML = 
                        '<div style="color: red;">❌ Payment completion failed. Please contact support.</div>';
                }
                
            } catch (error) {
                addDebugInfo(`❌ Error completing payment: ${error.message}`);
                document.getElementById('paymentStatus').innerHTML = 
                    '<div style="color: red;">❌ Error completing payment. Please contact support.</div>';
            }
        }
    </script>
</body>
</html>
